"use strict";function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,e){for(var i=0;i<e.length;i++){var s=e[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(t,s.key,s)}}function _createClass(t,e,i){return e&&_defineProperties(t.prototype,e),i&&_defineProperties(t,i),t}!function(){function t(t,e){for(var i=[],s=(e||document).querySelectorAll(t),n=0;n<s.length;n++)i.push(s[n]);return i}function e(t,e){var i=t.getAttribute(e);return i.indexOf(",")>-1&&(i=i.replace(" ","").split(",")),i instanceof Array?i:[i]}function i(t){var e=t.offsetWidth;return t.getBoundingClientRect().width/e}function s(t){var e=t.type.indexOf("touch")>-1?t.changedTouches[0]:t;return{x:e.clientX,y:e.clientY}}function n(t){return document.elementFromPoint(s(t).x,s(t).y)}function o(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{x:0,y:0};return{x:t.x+e.x,y:t.y+e.y}}var r="isDragging",a="complete",h="on",c=function(){function t(i){_classCallCheck(this,t),this.dom=i,this.style=this.getStyle(i),this.type=e(this.dom,"data-type"),this.index=e(this.dom,"data-index"),this.move=this.move.bind(this),this.resetPosition=this.resetPosition.bind(this),this.on=this.on.bind(this),this.normalize=this.normalize.bind(this),this.complete=this.complete.bind(this),this.offPointer=this.offPointer.bind(this),this.onPointer=this.onPointer.bind(this)}return _createClass(t,[{key:"getStyle",value:function(t){return{width:t.offsetWidth,height:t.offsetHeight,x:t.offsetLeft,y:t.offsetTop,centerX:t.offsetWidth/2,centerY:t.offsetHeight/2}}},{key:"setPosition",value:function(){this.style.x=this.dom.offsetLeft,this.style.y=this.dom.offsetTop}},{key:"move",value:function(t){var e=t.x,i=t.y;this.dom.style.left=e+"px",this.dom.style.top=i+"px"}},{key:"resetPosition",value:function(){this.dom.style.top="",this.dom.style.left="",this.style=this.getStyle(this.dom)}},{key:"on",value:function(){this.dom.classList.remove(a),this.dom.classList.add(h),this.dom.style.pointerEvents="none"}},{key:"complete",value:function(){this.isComplete=!0,this.dom.classList.remove(h),this.dom.classList.add(a)}},{key:"normalize",value:function(){this.isComplete=!1,this.dom.classList.remove(a),this.dom.classList.remove(h),this.dom.style.pointerEvents=""}},{key:"offPointer",value:function(){this.dom.style.pointerEvents="none"}},{key:"onPointer",value:function(){this.dom.style.pointerEvents=""}}]),t}(),l=function(){function t(e){var i=e.container,s=e.objs,n=e.options,o=e.callback;_classCallCheck(this,t),this.container=i,this.objs=this.setDragObjs(s),this.options=n,this.callback=o,this.isComplete=!1,this.start=this.start.bind(this),this.move=this.move.bind(this),this.end=this.end.bind(this),this.out=this.out.bind(this),this.correct=this.correct.bind(this),this.incorrect=this.incorrect.bind(this),this.container.addEventListener("mousedown",this.start),this.container.addEventListener("touchstart",this.start),this.container.addEventListener("pointerup",(function(t){t.stopPropagation()})),this.options.lock&&this.lockOn()}return _createClass(t,[{key:"zoomRate",get:function(){return i(this.container)}},{key:"isSameType",get:function(){var t=this;return this.currentObj.type.filter((function(e){return t.startObj.type.filter((function(t){return e==t})).length>0})).length>0}},{key:"isSameIndex",get:function(){var t=this;return this.currentObj.index.filter((function(e){return t.startObj.index.filter((function(t){return e==t})).length>0})).length>0}},{key:"isCorrect",get:function(){return!!this.options.free||!!this.currentObj&&((!this.options.noanswer||!this.isSameType)&&!(this.options.answer&&this.isSameType&&!this.isSameIndex))}},{key:"lockOn",value:function(){this.objs.forEach((function(t){"drop"==t.type&&t.offPointer()}))}},{key:"lockOff",value:function(){this.objs.forEach((function(t){"drop"==t.type&&t.onPointer()}))}},{key:"setDragObjs",value:function(t){return t.map((function(t){return new c(t)}))}},{key:"getCurrentObj",value:function(t){var e=this.objs.filter((function(e){return e.dom==t}));return e.length>0&&e[0]}},{key:"getIsEnter",value:function(t){var e=this.getCurrentObj(t),i=t==this.container;return e||i}},{key:"getIsCallback",value:function(t){return this.callback&&this.callback[t]}},{key:"getSameTypeObjs",value:function(){var t=this;return this.objs.filter((function(e){return e.type[0]===t.startObj.type[0]}))}},{key:"addEvent",value:function(){this.container.addEventListener("mousemove",this.move),this.container.addEventListener("touchmove",this.move),this.container.addEventListener("mouseup",this.end),this.container.addEventListener("touchend",this.end),this.container.addEventListener("mouseout",this.out)}},{key:"removeEvent",value:function(){this.container.removeEventListener("mousemove",this.move),this.container.removeEventListener("touchmove",this.move),this.container.removeEventListener("mouseup",this.end),this.container.removeEventListener("touchend",this.end),this.container.removeEventListener("mouseout",this.out),this.startObj&&this.startObj.normalize(),this.options.lock&&this.lockOn()}},{key:"cloneObj",value:function(t){var e=t.cloneNode(!0);return this.container.appendChild(e),new c(e)}},{key:"pointerOffSameTypeObjs",value:function(){this.sameTypeObjs.forEach((function(t){return t.offPointer()}))}},{key:"pointerOnSameTypeObjs",value:function(){this.sameTypeObjs.forEach((function(t){return t.onPointer()}))}},{key:"start",value:function(t){t.preventDefault(),t.stopPropagation(),this.startData=s(t),this.startObj=this.getCurrentObj(n(t)),this.startObj&&this.startObj!=this.container&&(console.log("start drag!!!!"),this.container.classList.add(r),this.sameTypeObjs=this.getSameTypeObjs(),this.options.copy&&!this.startObj.isClone&&(this.startObj=this.cloneObj(n(t)),this.startObj.isClone=!0,(this.options.answer||this.options.noanswer)&&this.pointerOffSameTypeObjs()),this.startObj.setPosition(),this.startObj.on(),this.addEvent(),this.getIsCallback("start")&&this.callback.start(this))}},{key:"move",value:function(t){t.preventDefault(),t.stopPropagation(),this.moveData=s(t);var e={x:(this.moveData.x-this.startData.x)/this.zoomRate+this.startObj.style.x,y:(this.moveData.y-this.startData.y)/this.zoomRate+this.startObj.style.y};this.startObj.move(e),this.options.lock&&this.lockOff(),this.getIsCallback("move")&&this.callback.move(this,e),this.getIsEnter(n(t))||this.out()}},{key:"end",value:function(t){this.container.classList.remove(r),this.currentObj=this.getCurrentObj(n(t)),this.pointerOnSameTypeObjs(),this.removeEvent(),this.getIsCallback("end")&&this.callback.end(this),this.isCorrect?this.correct():this.incorrect()}},{key:"out",value:function(){var t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];t&&this.getIsEnter(n(t))||(this.removeEvent(),this.resetObj(this.startObj),this.replay(),this.getIsCallback("out")&&this.callback.out(this))}},{key:"correct",value:function(){this.startObj.complete(),this.currentObj&&this.currentObj.complete(),this.options.copy&&!this.startObj.isPushed&&(this.objs.push(this.startObj),this.startObj.isPushed=!0),this.getIsCallback("correct")&&this.callback.correct(this)}},{key:"incorrect",value:function(){this.resetObj(this.startObj),this.replay(),this.getIsCallback("incorrect")&&this.callback.incorrect(this)}},{key:"resetObj",value:function(t){t.normalize(),t.resetPosition(),t.isClone&&this.isChild(t.dom)&&this.container.removeChild(t.dom)}},{key:"isChild",value:function(t){return this.container.contains(t)}},{key:"replay",value:function(){this.options.lock&&this.lockOn(),this.startObj=void 0,this.currentObj=void 0}},{key:"reset",value:function(){var t=this;this.removeEvent(),this.objs=this.objs.filter((function(e){if(t.resetObj(e),!e.isClone)return e})),this.replay()}}]),t}(),u=function(){function s(i){_classCallCheck(this,s),this.OPTS=i,this.container=i.container,this.answer=i.answer,this.style=this.setStyle(i),this.drawArea=this.setDrawArea(),this.resetButton=i.resetButton,this.answerButton=i.answerButton,this.options=this.setOptions(e(this.container,"data-option")),this.callback=i.callback,this.savedLines=[],this.isDrawingMode=this.options.drawing||!1,this.sideLines=[],this.isComplete=!1,this.binding(),this.DRAGDROP=new l({container:this.container,objs:t(".js-dragObj",this.container),zoomRate:this.zoomRate,options:this.options,callback:{start:this.start,move:this.move,end:this.end,out:this.out,correct:this.correct,incorrect:this.incorrect}}),this.resetButton&&(this.resetButton.addEventListener("click",this.reset),$efSound&&$efSound.click&&this.resetButton.addEventListener("click",$efSound.click),this.resetButton.addEventListener("touchstart",(function(t){t.stopPropagation()}))),this.answerButton&&(this.answerButton.addEventListener("click",this.toggleAnswer),$efSound&&$efSound.click&&this.answerButton.addEventListener("click",$efSound.click))}return _createClass(s,[{key:"zoomRate",get:function(){return i(this.container)}},{key:"binding",value:function(){this.start=this.start.bind(this),this.move=this.move.bind(this),this.end=this.end.bind(this),this.out=this.out.bind(this),this.correct=this.correct.bind(this),this.incorrect=this.incorrect.bind(this),this.reset=this.reset.bind(this),this.showAnswer=this.showAnswer.bind(this),this.toggleAnswer=this.toggleAnswer.bind(this)}},{key:"toggleAnswer",value:function(){this.isComplete?this.reset():this.showAnswer()}},{key:"changeAnswerButtonState",value:function(t){this.answerButton.setAttribute("data-type",t)}},{key:"setDrawArea",value:function(){var t=this.container.querySelector(".js-drawArea");return t.width=this.container.offsetWidth,t.height=this.container.offsetHeight,this.context=t.getContext("2d"),this.context&&(this.context.strokeStyle=this.style.lineColor,this.context.lineWidth=this.style.lineWidth,this.context.lineCap=this.style.lineCap,this.context.lineJoin=this.style.lineJoin,this.context.save()),t}},{key:"setStyle",value:function(t){return{lineColor:t.lineColor||"tomato",lineWidth:t.lineWidth||8,lineCap:t.lineCap||"round",lineJoin:t.lineJoin||"round"}}},{key:"setOptions",value:function(t){var e={};return""!==t&&(t instanceof Array?t.forEach((function(t){return e[t]=!0})):e[t]=!0),e}},{key:"getIsCallback",value:function(t){return this.callback&&this.callback[t]}},{key:"draw",value:function(t){var e=t.start,i=t.end;this.context.beginPath(),this.context.moveTo(e.x,e.y),this.context.lineTo(i.x,i.y),this.context.closePath(),this.context.stroke(),this.context.save()}},{key:"saveLine",value:function(){this.savedLines.push({start:this.startPointer,end:this.endPointer})}},{key:"drawSavedLines",value:function(){var t=this;this.savedLines.forEach((function(e){return t.draw({start:e.start,end:e.end})}))}},{key:"getMovedPointer",value:function(t){return{x:this.startPointer.x+(t.moveData.x-t.startData.x)/this.zoomRate,y:this.startPointer.y+(t.moveData.y-t.startData.y)/this.zoomRate}}},{key:"getDrawingStartPointer",value:function(t){return{x:(o(t).x-this.container.getBoundingClientRect().left)/this.zoomRate,y:(o(t).y-this.container.getBoundingClientRect().top)/this.zoomRate}}},{key:"start",value:function(t){this.startPointer=this.isDrawingMode?this.getDrawingStartPointer(t.startData):o(t.startObj.style,{x:t.startObj.style.centerX,y:t.startObj.style.centerY}),this.context.moveTo(this.startPointer.x,this.startPointer.y),this.context.beginPath(),this.endPointer=null,this.getIsCallback("start")&&this.callback.start(this)}},{key:"move",value:function(t,e){this.endPointer=this.isDrawingMode?this.getMovedPointer(t):o(e,{x:t.startObj.style.centerX,y:t.startObj.style.centerY}),this.context&&(this.isDrawingMode?(this.context.lineTo(this.endPointer.x,this.endPointer.y),this.context.stroke()):(this.refreshCanvas(),this.draw({start:this.startPointer,end:this.endPointer}))),this.container.style.zIndex=10,this.getIsCallback("move")&&this.callback.move(this)}},{key:"end",value:function(t){this.container.style.zIndex="",this.getIsCallback("end")&&this.callback.end(this)}},{key:"out",value:function(t){this.container.style.zIndex="",this.refreshCanvas(),this.getIsCallback("out")&&this.callback.out(this)}},{key:"correct",value:function(t){this.isDrawingMode||this.options.free||(this.endPointer=o(t.currentObj.style,{x:t.currentObj.style.centerX,y:t.currentObj.style.centerY})),this.endPointer||(this.endPointer=this.startPointer);var e,i,s,n=this.endPointer.x===this.startPointer.x&&this.endPointer.y===this.startPointer.y;this.context&&(this.options.copy||t.startObj.resetPosition(),this.refreshCanvas(),n||this.draw({start:this.startPointer,end:this.endPointer})),n||(this.sideLines.push({start:this.startPointer,end:this.endPointer,line:(e=this.startPointer,i=this.endPointer,s={},e.x>=i.x?s.x=e.x-i.x:s.x=i.x-e.x,e.y>=i.y?s.y=e.y-i.y:s.y=i.y-e.y,Math.round(s.x)*Math.round(s.x)+Math.round(s.y)*Math.round(s.y))}),this.saveLine()),this.getIsCallback("correct")&&this.callback.correct(this,this.RESULT)}},{key:"incorrect",value:function(){this.context&&this.refreshCanvas(),this.getIsCallback("incorrect")&&this.callback.incorrect(this)}},{key:"refreshCanvas",value:function(){this.clearCanvas(),this.drawSavedLines()}},{key:"clearCanvas",value:function(){this.context.clearRect(0,0,this.drawArea.width,this.drawArea.height)}},{key:"showAnswer",value:function(){var t=this;this.answer?(this.isComplete=!0,this.clearCanvas(),this.context.strokeStyle="#0060e3",this.answer.forEach((function(e){return t.draw({start:e.start,end:e.end})})),this.container.classList.add("pointerOff"),this.resetButton&&this.resetButton.classList.add("off"),this.answerButton&&this.changeAnswerButtonState("reset"),this.getIsCallback("showAnswer")&&this.callback.showAnswer(this)):alert("?�답???�력?�주?�요!")}},{key:"reset",value:function(){this.isComplete=!1,this.DRAGDROP.reset(),this.setDrawArea(),this.clearCanvas(),this.sideLines=[],this.rightAngleLength=0,this.savedLines=[],this.startPointer={x:0,y:0},this.endPointer={x:0,y:0},this.context.strokeStyle=this.style.lineColor,this.context.save(),this.container.classList.remove("pointerOff"),this.resetButton&&this.resetButton.classList.remove("off"),this.answerButton&&this.changeAnswerButtonState("answer"),this.getIsCallback("reset")&&this.callback.reset(this)}}]),s}();window.DrawLine=u}();