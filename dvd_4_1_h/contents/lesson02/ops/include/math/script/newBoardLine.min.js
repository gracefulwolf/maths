"use strict";function _classCallCheck(t,e){if(!_instanceof(t,e))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,e){for(var i=0;i<e.length;i++){var s=e[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(t,s.key,s)}}function _createClass(t,e,i){return e&&_defineProperties(t.prototype,e),i&&_defineProperties(t,i),t}function _instanceof(t,e){return null!=e&&"undefined"!=typeof Symbol&&e[Symbol.hasInstance]?!!e[Symbol.hasInstance](t):t instanceof e}(function(){function t(t,e){for(var i=[],s=e||document,n=s.querySelectorAll(t),o=0;o<n.length;o++)i.push(n[o]);return i.length>1?i:i[0]}function e(t,e){var i=t.getAttribute(e);return i.indexOf(",")>-1&&(i=i.replace(" ","").split(",")),_instanceof(i,Array)?i:[i]}function i(t){var e=t.offsetWidth,i=t.getBoundingClientRect().width;return i/e}function s(t){var e=t.type.indexOf("touch")>-1,i=e?t.changedTouches[0]:t;return{x:i.clientX,y:i.clientY}}function n(t){return document.elementFromPoint(s(t).x,s(t).y)}function o(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{x:0,y:0};return{x:t.x+e.x,y:t.y+e.y}}function r(t,e){var i={};return t.x>=e.x?i.x=t.x-e.x:i.x=e.x-t.x,t.y>=e.y?i.y=t.y-e.y:i.y=e.y-t.y,Math.round(i.x)*Math.round(i.x)+Math.round(i.y)*Math.round(i.y)}function a(t,e){return t.x===e.x&&t.y===e.y}var h=".js-dragObj",c=".js-drawArea",l="data-type",u="data-index",d="data-option",v="isDragging",f="complete",y="on",m=function(){function t(i){_classCallCheck(this,t),this.dom=i,this.style=this.getStyle(),this.type=e(this.dom,l),this.index=e(this.dom,u),this.move=this.move.bind(this),this.resetPosition=this.resetPosition.bind(this),this.on=this.on.bind(this),this.normalize=this.normalize.bind(this),this.complete=this.complete.bind(this),this.offPointer=this.offPointer.bind(this),this.onPointer=this.onPointer.bind(this)}return _createClass(t,[{key:"getStyle",value:function(){return{width:this.dom.offsetWidth,height:this.dom.offsetHeight,x:this.dom.offsetLeft,y:this.dom.offsetTop,centerX:this.dom.offsetWidth/2,centerY:this.dom.offsetHeight/2}}},{key:"setPosition",value:function(){this.style.x=this.dom.offsetLeft,this.style.y=this.dom.offsetTop}},{key:"move",value:function(t){var e=t.x,i=t.y;this.dom.style.left=e+"px",this.dom.style.top=i+"px"}},{key:"resetPosition",value:function(){this.dom.style.top="",this.dom.style.left=""}},{key:"on",value:function(){this.dom.classList.remove(f),this.dom.classList.add(y),this.dom.style.pointerEvents="none"}},{key:"complete",value:function(){this.isComplete=!0,this.dom.classList.remove(y),this.dom.classList.add(f)}},{key:"normalize",value:function(){this.isComplete=!1,this.dom.classList.remove(f),this.dom.classList.remove(y),this.dom.style.pointerEvents=""}},{key:"offPointer",value:function(){this.dom.style.pointerEvents="none"}},{key:"onPointer",value:function(){this.dom.style.pointerEvents=""}},{key:"reset",value:function(){this.style=this.getStyle()}}]),t}(),b=function(){function t(e){var s=e.container,n=e.objs,o=(e.zoomRate,e.options),r=e.callback;_classCallCheck(this,t),this.container=s,this.objs=this.setDragObjs(n),this.zoomRate=i(this.container),this.options=o,this.callback=r,this.isComplete=!1,this.start=this.start.bind(this),this.move=this.move.bind(this),this.end=this.end.bind(this),this.out=this.out.bind(this),this.correct=this.correct.bind(this),this.incorrect=this.incorrect.bind(this),this.container.addEventListener("mousedown",this.start),this.container.addEventListener("touchstart",this.start),this.container.addEventListener("pointerup",function(t){t.stopPropagation()}),this.options.lock&&this.lockOn()}return _createClass(t,[{key:"lockOn",value:function(){this.objs.forEach(function(t){"drop"==t.type&&t.offPointer()})}},{key:"lockOff",value:function(){this.objs.forEach(function(t){"drop"==t.type&&t.onPointer()})}},{key:"setDragObjs",value:function(t){return t.map(function(t){var e=new m(t);return e})}},{key:"getCurrentObj",value:function(t){var e=this.objs.filter(function(e){return e.dom==t});return e.length>0&&e[0]}},{key:"getIsEnter",value:function(t){var e=this.getCurrentObj(t),i=t==this.container;return e||i}},{key:"getIsCallback",value:function(t){return this.callback&&this.callback[t]}},{key:"getSameTypeObjs",value:function(){var t=this;return this.objs.filter(function(e){return e.type[0]===t.startObj.type[0]})}},{key:"addEvent",value:function(){this.container.addEventListener("mousemove",this.move),this.container.addEventListener("touchmove",this.move),this.container.addEventListener("mouseup",this.end),this.container.addEventListener("touchend",this.end),this.container.addEventListener("mouseout",this.out)}},{key:"removeEvent",value:function(){this.container.removeEventListener("mousemove",this.move),this.container.removeEventListener("touchmove",this.move),this.container.removeEventListener("mouseup",this.end),this.container.removeEventListener("touchend",this.end),this.container.removeEventListener("mouseout",this.out),this.startObj&&this.startObj.normalize(),this.options.lock&&this.lockOn()}},{key:"cloneObj",value:function(t){var e=t.cloneNode(!0);return this.container.appendChild(e),new m(e)}},{key:"pointerOffSameTypeObjs",value:function(){this.sameTypeObjs.forEach(function(t){return t.offPointer()})}},{key:"pointerOnSameTypeObjs",value:function(){this.sameTypeObjs.forEach(function(t){return t.onPointer()})}},{key:"start",value:function(t){t.preventDefault(),t.stopPropagation(),this.startData=s(t),this.startObj=this.getCurrentObj(n(t)),this.startObj&&this.startObj!=this.container&&(console.log("start drag!!!!"),this.container.classList.add(v),this.sameTypeObjs=this.getSameTypeObjs(),this.options.copy&&!this.startObj.isClone&&(this.startObj=this.cloneObj(n(t)),this.startObj.isClone=!0,(this.options.answer||this.options.noanswer)&&this.pointerOffSameTypeObjs()),this.startObj.setPosition(),this.startObj.on(),this.addEvent(),this.getIsCallback("start")&&this.callback.start(this))}},{key:"move",value:function(t){t.preventDefault(),t.stopPropagation(),this.moveData=s(t);var e={x:(this.moveData.x-this.startData.x)/this.zoomRate+this.startObj.style.x,y:(this.moveData.y-this.startData.y)/this.zoomRate+this.startObj.style.y};this.startObj.move(e),this.options.lock&&this.lockOff(),this.getIsCallback("move")&&this.callback.move(this,e),this.getIsEnter(n(t))||this.out()}},{key:"end",value:function(t){this.container.classList.remove(v),this.currentObj=this.getCurrentObj(n(t)),this.pointerOnSameTypeObjs(),this.removeEvent(),this.getIsCallback("end")&&this.callback.end(this),this.isCorrect?this.correct():this.incorrect()}},{key:"out",value:function(){var t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];t&&this.getIsEnter(n(t))||(this.removeEvent(),this.resetObj(this.startObj),this.replay(),this.getIsCallback("out")&&this.callback.out(this))}},{key:"correct",value:function(){this.startObj.complete(),this.currentObj.complete(),this.options.copy&&!this.startObj.isPushed&&this.container.removeChild(this.startObj.dom),this.getIsCallback("correct")&&this.callback.correct(this)}},{key:"incorrect",value:function(){var t=this.startObj;this.resetObj(this.startObj),this.replay(),this.getIsCallback("incorrect")&&this.callback.incorrect(this,t)}},{key:"resetObj",value:function(t){t.normalize(),t.resetPosition(),t.reset()}},{key:"isChild",value:function(t){return this.container.hasChildNodes(t)}},{key:"replay",value:function(){this.options.lock&&this.lockOn(),this.startObj=void 0,this.currentObj=void 0}},{key:"reset",value:function(){var t=this;this.removeEvent(),this.zoomRate=i(this.container),this.objs=this.objs.filter(function(e){if(t.resetObj(e),!e.isClone)return e}),this.replay()}},{key:"isSameType",get:function(){var t=this;return this.currentObj.type.filter(function(e){return t.startObj.type.filter(function(t){return e==t}).length>0}).length>0}},{key:"isSameIndex",get:function(){var t=this;return this.currentObj.index.filter(function(e){return t.startObj.index.filter(function(t){return e==t}).length>0}).length>0}},{key:"isCorrect",get:function(){return!!this.options.free||!(!this.currentObj||this.currentObj===this.startObj)&&((!this.options.noanswer||!this.isSameType)&&!(this.options.answer&&this.isSameType&&!this.isSameIndex))}}]),t}(),k=function(){function s(n){var o=this;_classCallCheck(this,s),this.OPTS=n,this.container=n.container,this.zoomRate=i(this.container),this.style=this.setStyle(n),this.drawArea=this.setDrawArea(),this.resetButton=n.resetButton,this.answer=n.answer,this.answerButton=n.answerButton,this.options=this.setOptions(e(this.container,d)),this.callback=n.callback,this.savedLines=[],this.savedPointers=[],this.isInnerLine=!n.innerLine||!1!==n.innerLine,this.isShowAnswered=!1,this.start=this.start.bind(this),this.move=this.move.bind(this),this.end=this.end.bind(this),this.out=this.out.bind(this),this.correct=this.correct.bind(this),this.incorrect=this.incorrect.bind(this),this.showAnswer=this.showAnswer.bind(this),this.reset=this.reset.bind(this),this.DRAGDROP=new b({container:this.container,objs:t(h,this.container),zoomRate:this.zoomRate,options:this.options,callback:{start:this.start,move:this.move,end:this.end,out:this.out,correct:this.correct,incorrect:this.incorrect}}),this.resetButton&&(this.resetButton.addEventListener("touchstart",this.reset),this.resetButton.addEventListener("click",this.reset),this.resetButton.addEventListener("mouseover",function(t){o.resetButton.classList.add("hover")}),this.resetButton.addEventListener("mouseout",function(t){o.resetButton.classList.remove("hover")}),$efSound&&$efSound.click&&this.resetButton.addEventListener("click",$efSound.click)),this.answerButton&&(this.answerButton.addEventListener("touchstart",this.toggleAnswer.bind(this,this.answer)),this.answerButton.addEventListener("click",this.toggleAnswer.bind(this,this.answer)),this.answerButton.addEventListener("mouseover",function(t){o.answerButton.classList.add("hover")}),this.answerButton.addEventListener("mouseout",function(t){o.answerButton.classList.remove("hover")}),$efSound&&$efSound.click&&this.answerButton.addEventListener("click",$efSound.click))}return _createClass(s,[{key:"setDrawArea",value:function(){var e=t(c,this.container);return e.width=this.container.offsetWidth,e.height=this.container.offsetHeight,this.context=e.getContext("2d"),this.context&&(this.context.strokeStyle=this.style.lineColor,this.context.fillStyle=this.style.fillStyle,this.context.lineWidth=this.style.lineWidth,this.context.lineCap=this.style.lineCap,this.context.lineJoin=this.style.lineJoin,this.context.save()),e}},{key:"setStyle",value:function(t){return{lineColor:t.lineColor||"tomato",fillStyle:t.fillStyle||"tomato",lineWidth:t.lineWidth||10,lineCap:t.lineCap||"round",lineJoin:t.lineJoin||"round"}}},{key:"setOptions",value:function(t){var e={};return""!==t&&(_instanceof(t,Array)?t.forEach(function(t){return e[t]=!0}):e[t]=!0),e}},{key:"getIsCallback",value:function(t){return this.callback&&this.callback[t]}},{key:"getSamePointer",value:function(t,e){var i,s,n,o=this,r=!1;return t.forEach(function(h,c){s=a(e,h),i=c==t.length-1,!s||!o.isMaxed&&i||(n=c,r=!0)}),{result:r,index:n}}},{key:"draw",value:function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,i=0===this.savedPointers.length?[this.startPointer]:this.savedPointers.map(function(i,s){return e&&t.samePointerIndex===s?e:i}),s=function(){t.context.strokeStyle=t.OPTS.innerColor||"#fff",t.context.fillStyle=t.OPTS.innerColor||"#fff",t.context.lineWidth=t.style.lineWidth-10},n=function(e,i){0===i?t.context.moveTo(e.x,e.y):t.context.lineTo(e.x,e.y)},o=function(){t.context.beginPath(),i.forEach(n),e&&!t.isSamePointer&&t.context.lineTo(e.x,e.y),t.context.lineTo(i[0].x,i[0].y),t.context.closePath(),t.OPTS.innerLine&&t.context.fill(),t.context.stroke()};o(),this.OPTS.innerLine&&(s(),o()),this.context.restore(),this.context.save()}},{key:"saveLine",value:function(){this.savedLines.push({start:this.startPointer,end:this.endPointer})}},{key:"savePointer",value:function(){this.isSamePointer?this.savedPointers[this.samePointerIndex]=this.endPointer:this.savedPointers.push(this.endPointer)}},{key:"getMovedPointer",value:function(t){return{x:this.startPointer.x+(t.moveData.x-t.startData.x)/this.zoomRate,y:this.startPointer.y+(t.moveData.y-t.startData.y)/this.zoomRate}}},{key:"getDrawingStartPointer",value:function(t){return{x:(o(t).x-this.container.getBoundingClientRect().left)/this.zoomRate,y:(o(t).y-this.container.getBoundingClientRect().top)/this.zoomRate}}},{key:"start",value:function(t){this.startPointer=o(t.startObj.style,{x:t.startObj.style.centerX,y:t.startObj.style.centerY}),this.isSamePointer=this.getSamePointer(this.savedPointers,this.startPointer).result,this.samePointerIndex=this.getSamePointer(this.savedPointers,this.startPointer).index,this.endPointer=null,this.isMaxed&&!this.isSamePointer&&t.out(),this.getIsCallback("start")&&this.callback.start(this)}},{key:"move",value:function(t,e){this.endPointer=o(e,{x:t.startObj.style.centerX,y:t.startObj.style.centerY}),this.context&&(this.refreshCanvas(),this.draw(this.endPointer)),this.getIsCallback("move")&&this.callback.move(this)}},{key:"end",value:function(t){this.getIsCallback("end")&&this.callback.end(this)}},{key:"out",value:function(t){this.refreshCanvas(),this.draw(),this.getIsCallback("out")&&this.callback.out(this)}},{key:"correct",value:function(t){this.endPointer=o(t.currentObj.style,{x:t.currentObj.style.centerX,y:t.currentObj.style.centerY}),this.context&&(this.options.copy||t.startObj.resetPosition(),0===this.savedPointers.length&&this.savedPointers.push(this.startPointer),this.savePointer(),this.refreshCanvas(),this.draw()),this.getIsCallback("correct")&&this.callback.correct(this,this.RESULT)}},{key:"incorrect",value:function(t,e){this.context&&(this.removePointer(),this.refreshCanvas(),this.draw()),this.getIsCallback("incorrect")&&this.callback.incorrect(this,e)}},{key:"removePointer",value:function(){var t=this,e=function(e){return console.log(!a(e,t.startPointer)),!a(e,t.startPointer)},i=this.savedPointers.filter(e);this.savedPointers=i}},{key:"refreshCanvas",value:function(){this.clearCanvas()}},{key:"clearCanvas",value:function(){this.context.clearRect(0,0,this.drawArea.width,this.drawArea.height)}},{key:"drawAnswer",value:function(t,e){this.savedPointers=t,this.context.strokeStyle="string"==typeof e?e:"#0060e3",this.draw(),this.context.strokeStyle=this.style.lineColor}},{key:"toggleAnswer",value:function(t){this.isShowAnswered?(this.isShowAnswered=!1,this.reset()):(this.isShowAnswered=!0,this.showAnswer(t))}},{key:"showAnswer",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;t&&(this.savedPointers=t,this.draw()),this.resetButton&&this.resetButton.classList.add("off"),this.getIsCallback("showAnswer")&&this.callback.showAnswer(this)}},{key:"reset",value:function(){this.setDrawArea(),this.zoomRate=i(this.container),this.DRAGDROP.reset(),this.clearCanvas(),this.savedPointers=[],this.rightAngleLength=0,this.savedLines=[],this.startPointer={x:0,y:0},this.endPointer={x:0,y:0},this.resetButton&&this.resetButton.classList.remove("off"),this.getIsCallback("reset")&&this.callback.reset(this,this.startObj)}},{key:"isMaxed",get:function(){return this.savedPointers.length===this.OPTS.maxLength}},{key:"sideLines",get:function(){var t=this,e=[];return this.savedPointers.forEach(function(i,s){var n=i,o=t.savedPointers[(s+1)%t.savedPointers.length],a=r(n,o);e.push({start:n,end:o,line:a})}),e}}]),s}();window.FigureBoardLine=k})();