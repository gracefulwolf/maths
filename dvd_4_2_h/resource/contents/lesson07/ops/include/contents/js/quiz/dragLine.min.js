"use strict";function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}function _createClass(Constructor,protoProps,staticProps){return protoProps&&_defineProperties(Constructor.prototype,protoProps),staticProps&&_defineProperties(Constructor,staticProps),Constructor}!function(){var OBJ_COMPLETE_CLASS="dragLineComplete",ANSWER_ATTR="data-answer",GROUP_ATTR="data-group",COMPLETE_CNT_ATTR="data-complete-count",TOTAL_COMPLETE_CNT_ATTR="data-total-complete-count",dragLine=function(){function dragLine(QUIZ){_classCallCheck(this,dragLine),this.QUIZ=QUIZ}return _createClass(dragLine,[{key:"init",value:function init(){this.initGame(),this.initDragObjs(),this.initSvg(),this.initPopupOpenCallback()}},{key:"initGame",value:function initGame(){var self=this,container=this.QUIZ.container,areas=container.querySelectorAll(".js-dragLineArea"),objs=container.querySelectorAll(".js-dragLineObj");this.game=initDragDrop({elements:{container:container,areas:areas,objs:objs},callbacks:{start:dragLine.startCallback,move:dragLine.moveCallback,movedOut:dragLine.movedOutCallback,end:dragLine.endCallback,getZoomRate:function getZoomRate(){return self.getZoomRate()}},movedOutCorrPx:20}),this.game.quiz=this,this.game.init(),container.addEventListener("pointerup",(function(e){e.stopPropagation()}))}},{key:"initDragObjs",value:function initDragObjs(){var game;this.game.dragObjs.forEach((function(dragObj){dragObj.answeredCnt=0}))}},{key:"initSvg",value:function initSvg(){var game=this.game,svg=this.QUIZ.container.querySelector(".js-svgContainer");game.totalAnsweredCnt=0,Object.defineProperties(game,{svg:{value:svg},lineNow:{get:function get(){return this._lineNow||null},set:function set(line){this._lineNow=line}},createLine:{value:function value(){var line=document.createElementNS("http://www.w3.org/2000/svg","line");return this.svg.appendChild(line),this.lineNow=line,line}},drawLine:{value:function value(obj,area){var line=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this.lineNow;if(!line)return!1;var beginCoords=line.beginCoords||this.getLineBeginCoords(obj),endCoords=line.endCoords||this.getLineEndCoords(area);return line.setAttribute("x1",beginCoords.x),line.setAttribute("y1",beginCoords.y),line.setAttribute("x2",endCoords.x),line.setAttribute("y2",endCoords.y),line}},removeLine:{value:function value(){var line=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.lineNow;if(!line)return!1;this.svg.removeChild(line),this.lineNow&&(this.lineNow=null)}},getLineBeginCoords:{value:function value(){var obj=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.movingObj,line=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.lineNow;if(!obj&&line)return!1;var coords=obj.offsets;return line.beginCoords=coords,coords}},getLineEndCoords:{value:function value(){var obj=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.movingObj,line=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.lineNow;if(!obj&&line)return!1;var coords=obj.offsets;return line.endCoords=coords,coords}},getMatchingObjOrArea:{value:function value(objOrArea){var constructorIsObj,type=objOrArea.constructor.toString().indexOf("DragObj")>-1?"obj":"area",group=objOrArea.element.dataset.group,answer=objOrArea.element.dataset.answer,target;return this.getSameGroupAndAnswer(type,group,answer)}},getSameGroupAndAnswer:{value:function value(type,group,answer){var array,returnObj;return("obj"===type?this.dropAreas:this.dragObjs).forEach((function(obj){group===obj.element.dataset.group&&answer===obj.element.dataset.answer&&(returnObj=obj)})),returnObj}},getSameName:{value:function value(type,name){var array,returnObj;return("obj"===type?this.dropAreas:this.dragObjs).forEach((function(obj){console.log({name:name,"obj.name":obj.name}),name===obj.name&&(returnObj=obj)})),returnObj}},checkAndDisableDragObjs:{value:function value(array){console.log(">>> checkAndDisableDragObjs"),array.forEach((function(obj){var CNT_IS_OVER=checkObjCntIsOver(obj);console.log({obj:obj,CNT_IS_OVER:CNT_IS_OVER}),CNT_IS_OVER&&obj.disable(!0)}))}}})}},{key:"initPopupOpenCallback",value:function initPopupOpenCallback(){var _this=this,self=this;window.$popupCallBack||(window.$popupCallBack={}),window.$popupCallBack.open=function(popup){"pageChange"===popup.Mode&&_this.popupOpenCallback()}}},{key:"endCorrect",value:function endCorrect(){console.log(">>> endCorrect");var game=this.game,startedObj=game.movingObj,endedArea=game.droppedArea,endedObj=game.getMatchingObjOrArea(endedArea),GAME_ENDED;console.log({startedObj:startedObj,endedArea:endedArea,endedObj:endedObj}),startedObj.answeredCnt++,endedObj.answeredCnt++,game.totalAnsweredCnt++,game.checkAndDisableDragObjs([startedObj,endedObj]),game.getLineEndCoords(endedArea),game.drawLine(),startedObj.resetPosition(),checkTotalCompleted(game)&&this.QUIZ.answerBtn&&this.QUIZ.answerBtn.classList.add("reset")}},{key:"endWrong",value:function endWrong(){this.game.removeLine(),this.game.movingObj.resetPosition()}},{key:"showAnswer",value:function showAnswer(){var _this2=this,game=this.game,objs=game.dragObjs,areas=game.dropAreas;objs.forEach((function(obj){obj.disable(!0),areas.forEach((function(area){area.disable(!0),_this2.checkAnswersAndDrawLines(obj,area)}))}))}},{key:"reset",value:function reset(){var game=this.game,answerBtn=this.QUIZ.answerBtn,RESET_ONLY;answerBtn&&answerBtn.dataset.option&&answerBtn.dataset.option.indexOf("resetOnly")>-1&&answerBtn.classList.add("reset"),this.game.totalAnsweredCnt=0,this.resetAreas(),this.resetObjs(),this.resetSvg(),game.initDragObjsCoords(),game.setZoomRate()}},{key:"resetObjs",value:function resetObjs(){this.game.dragObjs.forEach((function(obj){obj.answeredCnt=0,obj.disable(!1),obj.element.classList.remove("dragLineComplete")}))}},{key:"resetAreas",value:function resetAreas(){this.game.dropAreas.forEach((function(area){area.disable(!1)}))}},{key:"resetSvg",value:function resetSvg(){for(var game=this.game,svg,lines=game.svg.querySelectorAll("line"),i=0,len=lines.length,line;i<len;i++)line=lines[i],game.removeLine(line)}},{key:"popupOpenCallback",value:function popupOpenCallback(){var game=this.game;this.reset(),game.initDragObjsCoords(),game.setZoomRate()}},{key:"getZoomRate",value:function getZoomRate(){var container=this.QUIZ.container;return{x:container.getBoundingClientRect().width/container.offsetWidth,y:container.getBoundingClientRect().height/container.offsetHeight}}},{key:"checkAnswersAndDrawLines",value:function checkAnswersAndDrawLines(obj,area){var game=this.game,ANSWERED=checkAnswers(obj,area),SAME_GROUP=checkGroup(obj,area),CNT_IS_OVER;ANSWERED&&!SAME_GROUP&&(checkObjCntIsOver(obj)||(game.createLine(),game.drawLine(obj,area),obj.answeredCnt++))}}],[{key:"startCallback",value:function startCallback(dragLine){dragLine.movingObj&&(dragLine.createLine(),dragLine.getLineBeginCoords())}},{key:"moveCallback",value:function moveCallback(dragLine){dragLine.getLineEndCoords(),dragLine.drawLine()}},{key:"movedOutCallback",value:function movedOutCallback(DragDropCore){DragDropCore.removeLine()}},{key:"endCallback",value:function endCallback(dragLine){var obj=dragLine.movingObj,area=dragLine.droppedArea,quiz=dragLine.quiz,ANSWERED=checkAnswers(obj,area),SAME_GROUP=checkGroup(obj,area);area&&ANSWERED&&!SAME_GROUP?quiz.endCorrect():quiz.endWrong()}},{key:"convertScaleStringToArray",value:function convertScaleStringToArray(scaleString){var arr1=scaleString.split(","),x,y;return console.log(arr1),[arr1[0].split("(")[1],arr1[1].trim().split(")")[0]].map((function(item){return parseFloat(item.trim())}))}}]),dragLine}();function checkAnswers(obj,area){if(!area)return!1;var objAnsString=obj.element.getAttribute(ANSWER_ATTR)||"",objAnswerArr=switchStringNumListToArray(objAnsString,","),areaAnsString=area.element.getAttribute(ANSWER_ATTR)||"",areaAnswerArr=switchStringNumListToArray(areaAnsString,",");return objAnswerArr.some((function(objAnswer){return areaAnswerArr.some((function(areaAnswer){return objAnswer===areaAnswer}))}))}function checkGroup(obj,area){return!!area&&(parseInt(obj.element.getAttribute(GROUP_ATTR))||0)===(parseInt(area.element.getAttribute(GROUP_ATTR))||0);var objGroup,areaGroup}function checkObjCntIsOver(obj){var COMPLETE_CNT=parseInt(obj.element.getAttribute(COMPLETE_CNT_ATTR))||1,ANSWERED_CNT;return obj.answeredCnt>=COMPLETE_CNT}function checkTotalCompleted(game){var TOTAL_COMPLETE_CNT=parseInt(game.container.element.getAttribute(TOTAL_COMPLETE_CNT_ATTR)||"")||0;return game.totalAnsweredCnt===TOTAL_COMPLETE_CNT}window.$dragLine=dragLine}();